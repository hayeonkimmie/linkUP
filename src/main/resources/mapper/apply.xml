<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="mapper.apply">
    <select id="selectApplyProjectList" parameterType="map" resultType="apply">
        <![CDATA[
        SELECT
            a.apply_id,
            a.apply_date, -- 지원일
            a.cancel_date, -- 취소일
            CASE
                WHEN is_approved = true THEN '승인완료'
                ELSE '지원취소'
                END AS approved, -- 상태
            CASE
                WHEN cancel_date is null THEN '지원완료'
                ELSE '지원취소'
                END AS apply_status, -- 상태
            p.project_id,                                -- 프로젝트 ID
            IFNULL(( -- 카테고리
                       SELECT
                           GROUP_CONCAT(CONCAT(ca.category_name, ' > ', sc.sub_category_name)
                                        ORDER BY sc.sub_category_id SEPARATOR ', ')
                       FROM (
                                SELECT
                                    CAST(SUBSTRING_INDEX(SUBSTRING_INDEX(p.category, ',', numbers.n), ',', -1) AS UNSIGNED) AS sub_category_id
                                FROM (
                                         SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 UNION ALL SELECT 5
                                     ) AS numbers
                                WHERE numbers.n <= 1 + LENGTH(p.category) - LENGTH(REPLACE(p.category, ',', ''))
                            ) AS parsed
                                JOIN subCategory sc ON sc.sub_category_id = parsed.sub_category_id
                                JOIN category ca ON ca.category_id = sc.category_id
                   ), '') AS categories,
            p.advertisement_title,                       -- 공고 제목
            p.project_name,                              -- 프로젝트명
            CASE
                WHEN duration < 12 THEN CONCAT(duration, '개월')
                WHEN MOD(duration, 12) = 0 THEN CONCAT(duration DIV 12, '년')
                ELSE CONCAT(duration DIV 12, '년 ', MOD(duration, 12), '개월')
                END AS duration,                             -- 기간
            -- project_fee 서브쿼리
            IFNULL((
                       SELECT CONCAT(FORMAT(pay.project_fee, 0), '만 원')
                       FROM freelancer f
                                JOIN career ca ON f.freelancer_id = ca.freelancer_id
                                JOIN lv l ON PERIOD_DIFF(DATE_FORMAT(IFNULL(ca.resign_date, CURDATE()), '%Y%m'), DATE_FORMAT(ca.join_date, '%Y%m'))
                           BETWEEN l.start_month AND l.end_month
                                JOIN pay ON FIND_IN_SET(pay.sub_category_id, f.category) > 0
                           AND pay.lv_id = l.lv_id
                           AND pay.sub_category_id = p.category
                       WHERE f.freelancer_id = #{freelancerId}
                       LIMIT 1
                   ), '') AS project_fee,
            p.deadline_date,                             -- 마감일
            c.company_name,                              -- 회사명
            p.qualification,                             -- 자격 요건
            p.working_method,                            -- 근무 방식
            p.req_skills,                                -- 요구 스킬
            p.qualification,                            -- 자격 요건
            p.working_environment,                       -- 근무 환경
            p.working_hours,                             -- 근무 시간,
            CASE
                WHEN DATEDIFF(p.deadline_date, CURDATE()) > 0 THEN CONCAT('D-', DATEDIFF(p.deadline_date, CURDATE()))
                WHEN DATEDIFF(p.deadline_date, CURDATE()) = 0 THEN 'D-Day'
                ELSE '마감'
                END AS d_day                                 -- D-Day 표시
        FROM project p
                 JOIN client c ON p.client_id = c.client_id
                 JOIN apply a ON p.project_id = a.project_id
        WHERE a.freelancer_id = #{freelancerId}
        ORDER BY
            CASE
                WHEN DATEDIFF(p.deadline_date, CURDATE()) >= 0 THEN DATEDIFF(p.deadline_date, CURDATE())
                ELSE 99999
                END ASC, -- 임박 마감 우선
            a.apply_id DESC -- 최신 찜 우선
        LIMIT #{row}, 10
        ]]>
    </select>

</mapper>

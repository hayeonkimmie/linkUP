<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTO mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="mapper.project">
<!--    <insert id="" parameterType="">
        insert ammount ()
        values (#{}, #{},#{},#{})
    </insert>

    <select id="selectAllOngoingProjects" resultType="dto.Project">
        SELECT *
        FROM project
        WHERE status = '진행중'
    </select>-->

    <select id="MainProjectsByCategory" resultType="dto.Project" parameterType="String">
        SELECT
            p.project_name,
            p.client_id,
            p.category,
            p.advertisement_title,
            COALESCE(AVG(r.star), 0) AS avg_star,
            u.profile_img -- profile_img 추가

        FROM project p
                 LEFT JOIN review r ON p.client_id = r.r_user_id
                 LEFT JOIN user u ON p.client_id = u.user_id -- user 테이블 조인 추가

        WHERE p.category = #{category}

        GROUP BY p.project_id

        ORDER BY RAND()
            LIMIT 3
    </select>

    <select id="catalogProjectByCategory" parameterType="String" resultType="dto.Project">
        SELECT
            p.project_id,
            p.client_id,
            p.category,
            p.advertisement_title,
            p.project_name,
            p.thumbnail,
            p.duration,
            p.settle_day,
            p.manager,
            u.profile_img,
            COALESCE(AVG(r.star), 0) AS avg_star  <!-- ⭐ 별점 평균 추가 -->
        FROM project p
                 LEFT JOIN user u ON p.client_id = u.user_id
                 LEFT JOIN review r ON p.client_id = r.r_user_id  <!-- 리뷰 테이블 조인 -->
        WHERE p.category = #{category}
        GROUP BY p.project_id
        ORDER BY p.created_date DESC
    </select>
    <select id="searchProjectsByCategoryAndKeyword" parameterType="map" resultType="dto.Project">
        SELECT
            p.project_id,
            p.client_id,
            p.category,
            p.advertisement_title,
            p.project_name,
            p.thumbnail,
            p.duration,
            p.settle_day,
            p.manager,
            u.profile_img,
        COALESCE(AVG(r.star), 0) AS avg_star  <!-- ⭐ 별점 평균 추가 -->

        FROM project p
                 LEFT JOIN user u ON p.client_id = u.user_id
        LEFT JOIN review r ON p.client_id = r.r_user_id  <!-- ⭐ 리뷰 테이블 조인 -->
        WHERE p.category = #{category}
          AND (
            p.advertisement_title LIKE CONCAT('%', #{keyword}, '%')
                OR p.manager LIKE CONCAT('%', #{keyword}, '%')
            )
        GROUP BY p.project_id  <!-- ⭐ 집계함수 쓰면 GROUP BY 필요 -->
        ORDER BY p.created_date DESC
    </select>

</mapper>
